services:
  # PostgreSQL para a aplicação Next.js
  app-database:
    container_name: whatsapp_manager_db
    image: postgres:15-alpine
    restart: always
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: whatsapp_user
      POSTGRES_PASSWORD: fdx2025
      POSTGRES_DB: whatsapp_groups
    volumes:
      - app_postgres_data:/var/lib/postgresql/data
    networks:
      - whatsapp_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whatsapp_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL para a Evolution API
  evolution-database:
    container_name: evolution_api_db
    image: postgres:15-alpine
    restart: always
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: evolution
      POSTGRES_PASSWORD: evolution
      POSTGRES_DB: evolution
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data
    networks:
      - whatsapp_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Evolution API - Servidor WhatsApp
  evolution-api:
    container_name: evolution_api_server
    image: atendai/evolution-api:v2.1.1
    restart: always
    ports:
      - "8080:8080"
    environment:
      # Server
      SERVER_URL: http://localhost:8080
      SERVER_TYPE: http

      # API Key (IMPORTANTE: Trocar em produção!)
      AUTHENTICATION_API_KEY: B6D711FCDE4D4FD5936544120E713976
      AUTHENTICATION_TYPE: apikey

      # Database PostgreSQL
      DATABASE_ENABLED: true
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://evolution:evolution@evolution-database:5432/evolution
      DATABASE_CONNECTION_CLIENT_NAME: evolution_api
      DATABASE_SAVE_DATA_INSTANCE: true
      DATABASE_SAVE_DATA_NEW_MESSAGE: true
      DATABASE_SAVE_MESSAGE_UPDATE: true
      DATABASE_SAVE_DATA_CONTACTS: true
      DATABASE_SAVE_DATA_CHATS: true
      DATABASE_SAVE_DATA_LABELS: true
      DATABASE_SAVE_DATA_HISTORIC: true

      # Logs
      LOG_LEVEL: ERROR,WARN,DEBUG,INFO,LOG,VERBOSE,DARK,WEBHOOKS
      LOG_COLOR: true
      LOG_BAILEYS: error

      # QR Code
      QRCODE_LIMIT: 30
      QRCODE_COLOR: "#198754"

      # Webhook para nossa aplicação
      WEBHOOK_GLOBAL_URL: http://whatsapp-manager:3000/api/webhooks/evolution
      WEBHOOK_GLOBAL_ENABLED: true
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: true

      # Configurações adicionais
      CONFIG_SESSION_PHONE_CLIENT: "WhatsApp Manager"
      CONFIG_SESSION_PHONE_NAME: "Chrome"

      # Desabilitar Redis (não necessário para uso básico)
      CACHE_REDIS_ENABLED: false

    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    depends_on:
      evolution-database:
        condition: service_healthy
    networks:
      - whatsapp_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/instance/fetchInstances -H 'apikey: B6D711FCDE4D4FD5936544120E713976' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5

  # Aplicação Next.js - WhatsApp Manager
  whatsapp-manager:
    container_name: whatsapp_manager_app
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Evolution API
      EVOLUTION_API_URL: http://evolution-api:8080
      EVOLUTION_API_KEY: B6D711FCDE4D4FD5936544120E713976

      # Database
      DATABASE_URL: postgresql://whatsapp_user:fdx2025@app-database:5432/whatsapp_groups?schema=public

      # App
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      NODE_ENV: production

      # Admin Auth
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123

      # Security
      JWT_SECRET: telegrafo-jwt-secret-key-2024-muito-segura
      SESSION_SECRET: sua-chave-secreta-muito-forte-aqui-troque-em-producao

      # Webhook
      WEBHOOK_SECRET: webhook-secret-super-seguro-123

    volumes:
      # Persistir autenticação do Baileys
      - baileys_auth:/app/baileys-auth
    depends_on:
      app-database:
        condition: service_healthy
      evolution-api:
        condition: service_started
    networks:
      - whatsapp_network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  app_postgres_data:
    driver: local
  evolution_postgres_data:
    driver: local
  evolution_instances:
    driver: local
  evolution_store:
    driver: local
  baileys_auth:
    driver: local

networks:
  whatsapp_network:
    driver: bridge
